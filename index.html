<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Apple-Style Finance Suite ‚Äî Interactive Graphs</title>

<style>
/* =========================
   THEME VARIABLES (Light)
   ========================= */
:root{
  --bg: #ffffff;
  --panel: #f7f9fc;
  --card: #ffffff;
  --muted: #6b7280;
  --text: #0b2545;
  --shadow: rgba(11,37,69,0.08);
  --glass: rgba(255,255,255,0.6);
  --accent: #007aff; /* Pacific Blue */
  --accent-weak: rgba(0,122,255,0.12);
  --tooltip-bg: rgba(255,255,255,0.98);
  --tooltip-text: #0b2545;
  --border: rgba(11,37,69,0.06);
  --card-radius: 14px;
  --glass-blur: 8px;
}

/* =========================
   DARK THEME (Apple-like)
   ========================= */
:root.dark{
  --bg: #0b1220;
  --panel: #071029;
  --card: #0f1724;
  --muted: #9aa6b2;
  --text: #e6eef6;
  --shadow: rgba(0,0,0,0.6);
  --glass: rgba(255,255,255,0.03);
  --accent: #0a84ff;
  --accent-weak: rgba(10,132,255,0.12);
  --tooltip-bg: rgba(20,28,40,0.95);
  --tooltip-text: #e6eef6;
  --border: rgba(255,255,255,0.04);
  --card-radius: 14px;
}

/* =========================
   Base styles
   ========================= */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--text);
  font-family: Inter, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  transition: background .25s ease, color .25s ease;
}
.container{max-width:1080px; margin:20px auto; padding:16px;}
.header{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:14px 0 18px 0;
}
.brand{
  display:flex; gap:12px; align-items:center;
}
.logo{
  width:48px; height:48px; border-radius:12px; display:inline-flex; align-items:center; justify-content:center;
  background: linear-gradient(135deg, var(--accent), #4fb0ff); color:white; font-weight:800; font-size:18px;
  box-shadow: 0 6px 18px var(--shadow);
}
.title{
  font-size:18px; font-weight:700; letter-spacing:0.2px;
}
.subtitle{font-size:12px; color:var(--muted)}

/* theme toggle */
.controls{display:flex; gap:10px; align-items:center}
.toggle{
  border-radius:999px; padding:8px 12px; border:1px solid var(--border); background:var(--card); cursor:pointer;
  display:inline-flex; gap:8px; align-items:center; font-weight:700;
  box-shadow:0 6px 16px var(--shadow);
}

/* grid */
.grid{display:grid; grid-template-columns:repeat(12,1fr); gap:18px}
.col-6{grid-column:span 6}
.col-4{grid-column:span 4}
.col-12{grid-column:span 12}
@media (max-width:940px){ .col-6,.col-4{grid-column:span 12} .grid{gap:14px} }

/* card */
.card{
  background:var(--card); border-radius:var(--card-radius); padding:16px; box-shadow:0 12px 30px var(--shadow);
  border:1px solid var(--border); transition: transform .16s ease, box-shadow .16s ease;
}
.card:hover{ transform:translateY(-6px) }
.h2{font-size:16px; margin:0 0 6px 0; font-weight:700}
.p-sm{font-size:12px; color:var(--muted); margin:0 0 10px 0}

/* form */
.input{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text); margin-top:8px}
.button{background:var(--accent); color:white; padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:700; margin-top:10px}
.button:hover{filter:brightness(.96)}
.row{display:flex; gap:10px; align-items:center}
.kpi{padding:8px 10px; border-radius:10px; background:var(--panel); color:var(--muted); font-weight:700}

/* result */
.result{margin-top:10px; font-weight:800; color:var(--accent); font-size:1.05rem}

/* canvas container */
.chart-wrap{margin-top:12px; border-radius:10px; overflow:hidden; background:linear-gradient(180deg, transparent, rgba(0,0,0,0.02)); padding:8px}
.canvas{width:100%; height:220px; display:block}

/* tooltip capsule (Apple-style) */
.tooltip{
  position:fixed; pointer-events:none; z-index:9999;
  background:var(--tooltip-bg); color:var(--tooltip-text);
  padding:8px 12px; border-radius:999px; font-weight:700; font-size:13px;
  box-shadow: 0 8px 24px rgba(11,37,69,0.12);
  transform: translate(-50%, -140%); white-space:nowrap; transition: transform .12s ease, opacity .12s ease;
  opacity:0;
  border:1px solid var(--border);
}
.tooltip.show{opacity:1}

/* footer */
.footer{margin-top:18px; padding:12px; border-radius:10px; background:var(--panel); color:var(--muted); font-size:13px}
.footer .note{margin-top:8px}
.small{font-size:12px;color:var(--muted)}

/* responsiveness for small devices */
@media (max-width:520px){
  .logo{width:40px;height:40px;font-size:16px}
  .title{font-size:16px}
  .canvas{height:180px}
  .tooltip{font-size:12px;padding:6px 10px}
}
</style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="brand">
      <div class="logo">AF</div>
      <div>
        <div class="title">Apple-Style Finance Suite</div>
        <div class="subtitle">Interactive calculators & graphs ‚Äî Pacific Blue accents</div>
      </div>
    </div>

    <div class="controls">
      <button id="copyTheme" class="toggle" title="Toggle theme (light/dark)">üåô Theme</button>
      <button id="resetBtn" class="toggle" title="Reset graphs">‚ü≥ Reset</button>
    </div>
  </div>

  <!-- Grid -->
  <div class="grid">

    <!-- Debentures -->
    <div class="card col-6">
      <div class="h2">Cost of Debentures</div>
      <div class="p-sm">(Interest / Net proceeds) √ó (1 ‚àí Tax)</div>
      <input id="debInterest" class="input" placeholder="Annual Interest (‚Çπ)" />
      <input id="debNet" class="input" placeholder="Net Proceeds (‚Çπ)" />
      <input id="debTax" class="input" placeholder="Tax Rate (%)" />
      <div class="row">
        <button class="button" onclick="calcDebenture()">Calculate</button>
        <div id="debResult" class="result"></div>
      </div>
      <div class="chart-wrap"><canvas id="debChart" class="canvas"></canvas></div>
    </div>

    <!-- CAPM -->
    <div class="card col-6">
      <div class="h2">Cost of Equity (CAPM)</div>
      <div class="p-sm">Re = Rf + Œ≤ (Rm ‚àí Rf)</div>
      <input id="capmRf" class="input" placeholder="Risk-free rate (%)" />
      <input id="capmBeta" class="input" placeholder="Beta (Œ≤)" />
      <input id="capmRm" class="input" placeholder="Market return (%)" />
      <div class="row">
        <button class="button" onclick="calcCAPM()">Calculate</button>
        <div id="capmResult" class="result"></div>
      </div>
      <div class="chart-wrap"><canvas id="capmChart" class="canvas"></canvas></div>
    </div>

    <!-- DGM -->
    <div class="card col-6">
      <div class="h2">Dividend Growth Model (DGM)</div>
      <div class="p-sm">Re = (D‚ÇÅ / P‚ÇÄ) + g</div>
      <input id="dgmD1" class="input" placeholder="Next year dividend D1 (‚Çπ)" />
      <input id="dgmP0" class="input" placeholder="Current price P0 (‚Çπ)" />
      <input id="dgmG" class="input" placeholder="Growth rate g (%)" />
      <div class="row">
        <button class="button" onclick="calcDGM()">Calculate</button>
        <div id="dgmResult" class="result"></div>
      </div>
      <div class="chart-wrap"><canvas id="dgmChart" class="canvas"></canvas></div>
    </div>

    <!-- WACC -->
    <div class="card col-6">
      <div class="h2">WACC</div>
      <div class="p-sm">(E/V)Re + (D/V)Rd(1 ‚àí Tc)</div>
      <input id="waccE" class="input" placeholder="Market value of equity (E)" />
      <input id="waccD" class="input" placeholder="Market value of debt (D)" />
      <input id="waccRe" class="input" placeholder="Cost of equity (%)" />
      <input id="waccRd" class="input" placeholder="Cost of debt (%)" />
      <input id="waccTax" class="input" placeholder="Tax rate (%)" />
      <div class="row">
        <button class="button" onclick="calcWACC()">Calculate</button>
        <div id="waccResult" class="result"></div>
      </div>

      <div style="display:flex; gap:12px; margin-top:12px; align-items:center;">
        <div style="flex:1"><div class="chart-wrap"><canvas id="waccPie" class="canvas" style="height:140px;"></canvas></div></div>
        <div style="flex:1"><div class="chart-wrap"><canvas id="waccBar" class="canvas" style="height:140px;"></canvas></div></div>
      </div>
    </div>

    <!-- Beta -->
    <div class="card col-6">
      <div class="h2">Beta Calculator</div>
      <div class="p-sm">Œ≤ = Cov(Ri, Rm) / Var(Rm)</div>
      <input id="betaCov" class="input" placeholder="Covariance with market (decimal)" />
      <input id="betaVar" class="input" placeholder="Variance of market (decimal)" />
      <div class="row">
        <button class="button" onclick="calcBeta()">Calculate</button>
        <div id="betaResult" class="result"></div>
      </div>
    </div>

    <!-- Multi-Stage DDM -->
    <div class="card col-12">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <div>
          <div class="h2">Multi-Stage Dividend Discount Model (2-stage)</div>
          <div class="p-sm">High growth for N years, then stable growth</div>
        </div>
        <div class="small">Interactive chart shows projected dividends & terminal value</div>
      </div>

      <div style="display:flex; gap:12px; margin-top:10px; flex-wrap:wrap;">
        <input id="msD0" class="input" placeholder="Current dividend D0 (‚Çπ)" style="flex:1; min-width:160px;" />
        <input id="msG1" class="input" placeholder="High growth g1 (%)" style="flex:1; min-width:140px;" />
        <input id="msYears" class="input" placeholder="High growth years (N)" style="width:120px;" />
        <input id="msG2" class="input" placeholder="Stable growth g2 (%)" style="flex:1; min-width:140px;" />
        <input id="msR" class="input" placeholder="Required return r (%)" style="flex:1; min-width:140px;" />
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="button" onclick="calcMSDDM()">Calculate</button>
        <div id="msResult" class="result"></div>
      </div>

      <div class="chart-wrap" style="margin-top:12px;">
        <canvas id="msChart" class="canvas"></canvas>
      </div>
    </div>

    <!-- Footer / explanations -->
    <div class="card col-12 footer">
      <div><strong>How these are calculated</strong></div>
      <div class="note small">
        <strong>DCF basics:</strong> Project cashflows/dividends and discount them at appropriate rate (WACC for firm free cash flows, required return for equity cash flows).<br><br>
        <strong>Terminal value (Gordon):</strong> TV = D_{n+1} / (r ‚àí g) ‚Äî only valid when r > g. <br><br>
        <strong>Sensitivity:</strong> Slight changes in growth or discount rate significantly affect valuations ‚Äî always run sensitivity checks.<br>
      </div>
    </div>

  </div>
</div>

<!-- Tooltip -->
<div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"></div>

<script>
/* =========================
   Utility helpers
   ========================= */
const $ = id => document.getElementById(id);
const n = v => { const x = parseFloat(v); return isNaN(x) ? 0 : x; };
const clamp = (v, a, b) => Math.min(b, Math.max(a, v));
function formatNum(x){ return (Math.round(x*100)/100).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}); }

/* =========================
   Theme toggle
   ========================= */
const themeBtn = $('copyTheme');
function applyStoredTheme(){
  const t = localStorage.getItem('theme');
  if (t === 'dark') document.documentElement.classList.add('dark');
  else document.documentElement.classList.remove('dark');
  themeBtn.textContent = document.documentElement.classList.contains('dark') ? '‚òÄÔ∏è Light' : 'üåô Dark';
}
themeBtn.onclick = () => {
  const isDark = document.documentElement.classList.toggle('dark');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  themeBtn.textContent = isDark ? '‚òÄÔ∏è Light' : 'üåô Dark';
};
applyStoredTheme();

/* =========================
   Tooltip (Apple floating capsule)
   ========================= */
const tooltip = $('tooltip');
function showTooltip(x, y, html){
  tooltip.innerHTML = html;
  tooltip.style.left = x + 'px';
  tooltip.style.top = y + 'px';
  tooltip.classList.add('show');
  tooltip.setAttribute('aria-hidden','false');
}
function hideTooltip(){ tooltip.classList.remove('show'); tooltip.setAttribute('aria-hidden','true'); }

/* =========================
   Canvas utilities (HiDPI aware)
   ========================= */
function setupCanvas(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.max(300, Math.floor(rect.width * dpr));
  canvas.height = Math.max(120, Math.floor(rect.height * dpr));
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.imageSmoothingEnabled = true;
  return ctx;
}
function clearCtx(ctx, canvas){ ctx.clearRect(0,0,canvas.width,canvas.height); }

/* =========================
   Simple chart helpers (curved line + area, points, tooltip)
   All charts built custom ‚Äî interactive on hover/touch
   ========================= */

function drawLineAreaChart(canvas, dataPoints, opts = {}){
  // opts: {lineColor, areaColor, labelFunc}
  const ctx = setupCanvas(canvas);
  clearCtx(ctx, canvas);
  const rect = canvas.getBoundingClientRect();
  const w = rect.width, h = rect.height;
  if (!dataPoints || dataPoints.length === 0){
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
    ctx.font = '13px Inter';
    ctx.fillText('No data', 12, 20);
    return;
  }
  // margins
  const left = 36, right = 16, top = 18, bottom = 28;
  const innerW = w - left - right, innerH = h - top - bottom;
  // compute min/max
  let vals = dataPoints.map(d => d.y);
  const min = Math.min(...vals); const max = Math.max(...vals);
  const range = (max - min) || 1;
  // scale function
  const xAt = i => left + (i/(dataPoints.length-1)) * innerW;
  const yAt = v => top + (1 - (v - min)/range) * innerH;
  // area path (use bezier smoothing)
  ctx.lineWidth = 2.2;
  ctx.strokeStyle = opts.lineColor || getComputedStyle(document.documentElement).getPropertyValue('--accent');
  ctx.fillStyle = opts.areaColor || (getComputedStyle(document.documentElement).getPropertyValue('--accent-weak') || 'rgba(0,122,255,0.12)');
  // build points
  const pts = dataPoints.map((p,i) => ({x:xAt(i), y:yAt(p.y), label:p.label, rawY:p.y}));
  // draw area
  ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=1;i<pts.length;i++){
    const prev = pts[i-1], cur = pts[i];
    const cx = (prev.x + cur.x)/2;
    ctx.quadraticCurveTo(prev.x, prev.y, cx, (prev.y+cur.y)/2);
  }
  ctx.lineTo(pts[pts.length-1].x, h - bottom);
  ctx.lineTo(pts[0].x, h - bottom);
  ctx.closePath();
  // fill
  ctx.globalAlpha = 0.22;
  ctx.fillStyle = opts.areaColor || (getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#007aff');
  ctx.fill();
  ctx.globalAlpha = 1;
  // draw line
  ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=1;i<pts.length;i++){
    const prev = pts[i-1], cur = pts[i];
    const cx = (prev.x + cur.x)/2;
    ctx.quadraticCurveTo(prev.x, prev.y, cx, (prev.y+cur.y)/2);
  }
  ctx.strokeStyle = opts.lineColor || getComputedStyle(document.documentElement).getPropertyValue('--accent');
  ctx.stroke();
  // draw points
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--card');
  for(let p of pts){
    ctx.beginPath();
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent');
    ctx.arc(p.x, p.y, 4, 0, Math.PI*2);
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.12)';
    ctx.lineWidth = 1.2;
    ctx.stroke();
  }
  // attach hover events (closure)
  attachHover(canvas, pts, opts);
}

function attachHover(canvas, pts, opts){
  // remove existing listeners
  const namespace = '__hover_attached__';
  if (canvas[namespace]) return; // already attached
  canvas[namespace] = true;
  let hoveredIndex = -1;
  function pointerHandler(e){
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX);
    const y = (e.touches ? e.touches[0].clientY : e.clientY);
    const localX = x - rect.left;
    // find nearest point
    let nearest = -1; let dist = 1e9;
    for(let i=0;i<pts.length;i++){
      const d = Math.abs(pts[i].x - localX);
      if (d < dist){ dist = d; nearest = i; }
    }
    if (nearest !== hoveredIndex && dist < 40){
      hoveredIndex = nearest;
      const p = pts[nearest];
      // position tooltip with edge detection
      const sx = rect.left + p.x;
      const sy = rect.top + p.y;
      const label = opts && opts.labelFunc ? opts.labelFunc(p.rawY, nearest) : (p.label || formatNum(p.rawY));
      showTooltip(sx, sy, `${label}`);
    } else if (dist >= 40){
      hoveredIndex = -1;
      hideTooltip();
    }
  }
  function leave(){ hideTooltip(); }
  canvas.addEventListener('mousemove', pointerHandler);
  canvas.addEventListener('touchstart', pointerHandler, {passive:true});
  canvas.addEventListener('mouseleave', leave);
  canvas.addEventListener('touchend', leave);
}

/* =========================
   Specific chart wrappers
   ========================= */

/* Debenture chart: show interest vs net proceeds % */
function drawDebentureChart(kdPct){
  const c = $('debChart');
  setupCanvas(c);
  const ctx = c.getContext('2d'); clearCtx(ctx, c);
  // simple sparkline representing kd
  const w = c.width/ (window.devicePixelRatio || 1), h = c.height/(window.devicePixelRatio || 1);
  ctx.fillStyle = 'transparent';
  // label
  ctx.font = '13px Inter';
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
  ctx.fillText('Post-tax cost: '+ formatNum(kdPct) + '%', 12, 18);
  // draw bar
  const barW = Math.max(12, Math.min(w-40, (kdPct/50) * (w-40)));
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent');
  ctx.fillRect(20, h/2 - 12, barW, 24);
}

/* CAPM: show a simple line across market premium (static) */
function drawCapmChart(Rf, Beta, Rm){
  const c = $('capmChart');
  const pts = [];
  const years = 8;
  let base = Rf;
  for(let i=0;i<years;i++){
    const y = base + Beta * (Rm - base) * (1 + (i/years)*0.06);
    pts.push({x:i, y});
  }
  drawLineAreaChart(c, pts, {lineColor: getComputedStyle(document.documentElement).getPropertyValue('--accent'), areaColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-weak'), labelFunc: v => `${formatNum(v)}%`});
}

/* DGM: sensitivity over small growth range */
function drawDgmChart(D1, P0){
  const c = $('dgmChart');
  if (!D1 || !P0){
    setupCanvas(c); const ctx = c.getContext('2d'); clearCtx(ctx,c);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
    ctx.fillText('Provide D1 and P0 to see DGM sensitivity', 12, 24);
    return;
  }
  // build series for required return r from 6%..14% show implied value per share for fixed g
  const pts = [];
  const g = (n($('dgmG').value) || 5)/100;
  for(let i=6;i<=14;i++){
    const r = i/100;
    if (r <= g) continue;
    const val = (D1 / P0 + g) / r; // relative metric
    pts.push({x:i, y: val});
  }
  drawLineAreaChart(c, pts, {lineColor: getComputedStyle(document.documentElement).getPropertyValue('--accent'), areaColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-weak'), labelFunc: v => `Value idx ${formatNum(v)}`});
}

/* WACC pie & bar */
function drawWaccPie(wE, wD){
  const c = $('waccPie');
  const ctx = setupCanvas(c); clearCtx(ctx,c);
  const rect = c.getBoundingClientRect(); const w = rect.width, h = rect.height;
  const cx = w/2, cy = h/2, r = Math.min(w,h)/4;
  const start = -Math.PI/2;
  const aE = wE * 2 * Math.PI;
  ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent'); ctx.arc(cx,cy,r,start,start + aE); ctx.closePath(); ctx.fill();
  ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--card'); ctx.arc(cx,cy,r,start + aE, start + 2*Math.PI); ctx.closePath(); ctx.fill();
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted'); ctx.font='12px Inter';
  ctx.fillText('Equity ' + (wE*100).toFixed(1) + '%', 10, 18);
  ctx.fillText('Debt ' + (wD*100).toFixed(1) + '%', 10, 34);
}

function drawWaccBar(wE, wD, Re, Rd, T){
  const c = $('waccBar');
  const ctx = setupCanvas(c); clearCtx(ctx,c);
  const rect = c.getBoundingClientRect(); const w = rect.width, h = rect.height;
  const pad = 28; const barW = (w - pad*2);
  const eqContrib = (wE * Re * 100), debtContrib = (wD * Rd * (1-T) * 100);
  const max = Math.max(eqContrib, debtContrib, 1);
  // equity
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent');
  ctx.fillRect(pad, 36, (eqContrib/max) * (barW/2), 18);
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
  ctx.fillText('Equity: ' + eqContrib.toFixed(2) + '%', pad, 32);
  // debt
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--card');
  ctx.fillRect(pad + barW/2 + 20, 36, (debtContrib/max) * (barW/2), 18);
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
  ctx.fillText('Debt (post-tax): ' + debtContrib.toFixed(2) + '%', pad + barW/2 + 20, 32);
}

/* Multi-stage DDM chart */
function drawMsChart(series){
  const c = $('msChart');
  drawLineAreaChart(c, series.map(s => ({x: s.t, y: s.D, label: `Year ${s.t}`})), {lineColor: getComputedStyle(document.documentElement).getPropertyValue('--accent'), areaColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-weak'), labelFunc: v => `‚Çπ${formatNum(v)}`});
}

/* =========================
   Calculator logic
   ========================= */

/* Debenture */
function calcDebenture(){
  const I = n($('debInterest').value);
  const NP = n($('debNet').value);
  const T = n($('debTax').value)/100;
  if (NP <= 0){ $('debResult').textContent = 'Net proceeds must be > 0'; drawDebentureChart(0); return; }
  const kd = (I / NP) * (1 - T) * 100;
  $('debResult').textContent = kd.toFixed(2) + '%';
  drawDebentureChart(kd);
}

/* CAPM */
function calcCAPM(){
  const Rf = n($('capmRf').value);
  const Beta = n($('capmBeta').value);
  const Rm = n($('capmRm').value);
  const Re = Rf + Beta * (Rm - Rf);
  $('capmResult').textContent = Re.toFixed(2) + '%';
  drawCapmChart(Rf, Beta, Rm);
}

/* DGM */
function calcDGM(){
  const D1 = n($('dgmD1').value);
  const P0 = n($('dgmP0').value);
  const g = n($('dgmG').value)/100;
  if (P0 <= 0){ $('dgmResult').textContent = 'Price must be > 0'; drawDgmChart(0,0); return; }
  const Re = (D1 / P0 + g) * 100;
  $('dgmResult').textContent = Re.toFixed(2) + '%';
  drawDgmChart(D1, P0);
}

/* WACC */
function calcWACC(){
  const E = n($('waccE').value);
  const D = n($('waccD').value);
  const Re = n($('waccRe').value)/100;
  const Rd = n($('waccRd').value)/100;
  const T = n($('waccTax').value)/100;
  const V = E + D;
  if (V <= 0){ $('waccResult').textContent = 'E + D > 0'; drawWaccPie(0,0); drawWaccBar(0,0,0,0,0); return; }
  const wE = E / V, wD = D / V;
  const wacc = (wE * Re) + (wD * Rd * (1 - T));
  $('waccResult').textContent = (wacc * 100).toFixed(2) + '%';
  drawWaccPie(wE, wD);
  drawWaccBar(wE, wD, Re, Rd, T);
}

/* Beta */
function calcBeta(){
  const cov = n($('betaCov').value);
  const v = n($('betaVar').value);
  if (v === 0){ $('betaResult').textContent = 'Variance cannot be 0'; return; }
  $('betaResult').textContent = (cov / v).toFixed(3);
}

/* Multi-stage DDM */
function calcMSDDM(){
  const D0 = n($('msD0').value);
  const g1 = n($('msG1').value)/100;
  const years = Math.max(0, Math.floor(n($('msYears').value)));
  const g2 = n($('msG2').value)/100;
  const r = n($('msR').value)/100;
  if (r <= g2){ $('msResult').textContent = 'r must be > stable growth g2'; drawMsChart([]); return; }
  let D = D0;
  let pv = 0;
  const series = [];
  for (let t=1;t<=years;t++){
    D = D * (1 + g1);
    pv += D / Math.pow(1 + r, t);
    series.push({t, D});
  }
  const terminal = (D * (1 + g2)) / (r - g2);
  pv += terminal / Math.pow(1 + r, years);
  series.push({t: years + 1, D: terminal});
  $('msResult').textContent = '‚Çπ' + formatNum(pv);
  drawMsChart(series);
}

/* =========================
   Initialize & event hookups
   ========================= */
function attachDefaults(){
  // small non-invasive defaults to show visuals
  if (!$('capmRf').value) $('capmRf').value = '3.5';
  if (!$('capmBeta').value) $('capmBeta').value = '1.1';
  if (!$('capmRm').value) $('capmRm').value = '10';
  if (!$('dgmG').value) $('dgmG').value = '4';
  if (!$('msG1').value) $('msG1').value = '12';
  if (!$('msYears').value) $('msYears').value = '5';
  if (!$('msG2').value) $('msG2').value = '4';
  // initial draws
  calcCapmChartInit();
}
function calcCapmChartInit(){ drawCapmChart(n($('capmRf').value), n($('capmBeta').value), n($('capmRm').value)); }

// reset
$('resetBtn').onclick = () => {
  document.querySelectorAll('canvas').forEach(c=> { setupCanvas(c); const ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); });
  attachDefaults();
  hideTooltip();
};

attachDefaults();

/* window resize: adapt canvases */
window.addEventListener('resize', () => {
  document.querySelectorAll('canvas').forEach(c => {
    try{ setupCanvas(c); } catch(e){}
  });
  // redraw visible charts based on current values
  calcDebenture(); calcCAPM(); calcDGM(); calcWACC(); calcMSDDM();
});

/* small helpers to draw initial placeholders */
function drawDebentureChart(kd){
  const c = $('debChart'); setupCanvas(c); const ctx = c.getContext('2d'); clearCtx(ctx,c);
  ctx.font = '13px Inter'; ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
  ctx.fillText(kd ? ('kd: ' + kd.toFixed(2) + '%') : 'Enter values to compute KD', 12, 20);
}
function drawCapmChart(Rf,Beta,Rm){ drawCapmChart(Rf,Beta,Rm); }
function drawDgmChart(D1,P0){ const c=$('dgmChart'); setupCanvas(c); const ctx=c.getContext('2d'); clearCtx(ctx,c); ctx.font='13px Inter'; ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted'); ctx.fillText(P0? 'DGM sensitivity shown' : 'Enter D1 & P0', 12, 20); }
function drawWaccPie(wE,wD){ const c=$('waccPie'); setupCanvas(c); const ctx=c.getContext('2d'); clearCtx(ctx,c); ctx.font='13px Inter'; ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted'); ctx.fillText('WACC components',12,18); }
function drawWaccBar(wE,wD,Re,Rd,T){ const c=$('waccBar'); setupCanvas(c); const ctx=c.getContext('2d'); clearCtx(ctx,c); ctx.font='13px Inter'; ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted'); ctx.fillText('Contributions',12,18); }
function drawMsChart(series){ const c=$('msChart'); setupCanvas(c); const ctx=c.getContext('2d'); clearCtx(ctx,c); ctx.font='13px Inter'; ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted'); ctx.fillText(series.length? 'Projected dividends chart' : 'Run MSDDM to see projection',12,20); }

/* initial placeholder draws */
document.querySelectorAll('canvas').forEach(c => { try{ setupCanvas(c);}catch(e){} });
drawDebentureChart(0); drawCapmChart(n($('capmRf').value), n($('capmBeta').value), n($('capmRm').value)); drawDgmChart(0,0); drawWaccPie(0.6,0.4); drawWaccBar(0.6,0.4,0.12,0.06,0.25); drawMsChart([]);

</script>
</body>
</html>
